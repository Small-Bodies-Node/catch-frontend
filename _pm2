#!/usr/bin/env bash
# Simple PM2 wrapper for Angular SSR server

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() { echo -e "${GREEN}[INFO]${NC} $*"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
error() { echo -e "${RED}[ERROR]${NC} $*"; exit 1; }

# Check pm2 is installed
if ! command -v pm2 >/dev/null 2>&1; then
  error "pm2 not found. Install with: npm i -g pm2"
fi

# Load .env if it exists
if [[ -f .env ]]; then
  set -a; source .env; set +a
  log "Loaded .env file"
fi

# Set variables AFTER loading .env so they can be overridden
APP_NAME="${PM2_APP_NAME:-NG20}"
START_FILE="${PM2_START_FILE:-dist/catch-frontend-ng20/server/server.mjs}"

# Build if needed
if [[ ! -f "$START_FILE" ]]; then
  log "Building application..."
  npm run build || error "Build failed"
fi

case "${1:-help}" in
  start)
    log "Starting $APP_NAME..."
    if pm2 describe "$APP_NAME" >/dev/null 2>&1; then
      pm2 restart "$APP_NAME" --update-env
    else
      pm2 start node --name "$APP_NAME" --time -- "$START_FILE"
    fi
    pm2 save
    log "Started $APP_NAME"
    ;;
  stop)
    log "Stopping $APP_NAME..."
    pm2 stop "$APP_NAME" || warn "App not running"
    ;;
  restart)
    log "Restarting $APP_NAME..."
    pm2 restart "$APP_NAME" --update-env || error "Restart failed"
    ;;
  logs)
    pm2 logs "$APP_NAME"
    ;;
  status)
    pm2 status
    ;;
  enable)
    log "Setting up systemd startup for PM2..."
    log "This will configure your system to automatically start PM2 on boot"
    log "User: $USER, Home: $HOME"
    log "Running: pm2 startup systemd -u $USER --hp $HOME"
    pm2 startup systemd -u "$USER" --hp "$HOME"
    log ""
    log "IMPORTANT: After running this command, you need to:"
    log "1. Start your app: ./_pm2 start"
    log "2. Save the PM2 configuration: pm2 save"
    log "3. The saved configuration will be automatically restored on system reboot"
    log ""
    log "To disable auto-start later, run: pm2 unstartup systemd"
    ;;
  delete)
    log "Deleting $APP_NAME from PM2..."
    pm2 delete "$APP_NAME" || warn "App not found in PM2"
    pm2 save
    log "Deleted $APP_NAME"
    ;;
  *)
    cat <<EOF
Usage: $0 {start|stop|restart|logs|status|enable|delete}

Environment:
  PM2_APP_NAME    App name (default: NG20)
  PM2_START_FILE  Start file (default: dist/catch-frontend-ng20/server/server.mjs)
EOF
    ;;
esac